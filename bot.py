import asyncio
from aiogram import Bot, Dispatcher, types, F
from aiogram.client.default import DefaultBotProperties
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
from config import BOT_TOKEN
from db import init_db, add_user, get_progress

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ —Å parse_mode —á–µ—Ä–µ–∑ DefaultBotProperties
bot = Bot(
    token=BOT_TOKEN,
    default=DefaultBotProperties(parse_mode="HTML")
)

dp = Dispatcher()

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π "–ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å"
keyboard = ReplyKeyboardMarkup(
    keyboard=[[KeyboardButton(text="–ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å")]],
    resize_keyboard=True
)

@dp.message(F.text.startswith("/start"))
async def start_handler(message: types.Message):
    args = message.text.split(" ")[1:]  # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ —Å—Å—ã–ª–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    user_id = message.from_user.id

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫—Ç–æ –ø—Ä–∏–≥–ª–∞—Å–∏–ª (–µ—Å–ª–∏ –µ—Å—Ç—å)
    ref_by = int(args[0]) if args and args[0].isdigit() and int(args[0]) != user_id else None
    await add_user(user_id, ref_by)

    ref_count = await get_progress(user_id)

    if ref_count < 5:
        await message.answer(
            f"üëã <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å LEKOMODA !</b>\n\n"
            f"üìö –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —É—Ä–æ–∫–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ 5 —Å–≤–æ–∏—Ö –¥—Ä—É–∑–µ–π üë• .\n\n"
            f"<b>–ü–µ—Ä–µ–æ—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–≤–æ–∏–º –¥—Ä—É–∑—å—è–º üìé  :</b>\n"
            f"https://t.me/lekomodabot?start={user_id}\n\n"
            f"<b>–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:</b>\n"
            f"1. –≠—Ç–æ –≤–∞—à–∞ –ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞\n"
            f"2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—ë —Å–≤–æ–∏–º –¥—Ä—É–∑—å—è–º\n"
            f"3. –ö–æ–≥–¥–∞ 5 —á–µ–ª–æ–≤–µ–∫ –Ω–∞–∂–º—É—Ç ‚Äú–°—Ç–∞—Ä—Ç ‚ñ∂Ô∏è ‚Äù –ø–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ ‚Äî –¥–æ—Å—Ç—É–ø –æ—Ç–∫—Ä–æ–µ—Ç—Å—è!\n\n"
            f"–í—ã –ø—Ä–∏–≥–ª–∞—Å–∏–ª–∏ <b>{ref_count}</b> –∏–∑ 5 –¥—Ä—É–∑–µ–π üë• .\n\n" 

            "<b>üìö –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —É—Ä–æ–∫–æ–≤:</b>\n"
            "‚Ä¢ –í–≤–µ–¥–µ–Ω–∏–µ –≤ —Ü–∏—Ñ—Ä–æ–≤–æ–µ –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–¥–µ–∂–¥—ã\n"
            "‚Ä¢ –ü—Ä–æ—Å—Ç—ã–µ –ø—Ä–æ–µ–∫—Ç—ã –¥–ª—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏\n"
            "‚Ä¢ –°–æ–≤–µ—Ç—ã –ø–æ –≤—ã–±–æ—Ä—É –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è\n\n"
            "<b>üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–ª–∞—Ç–Ω—ã—Ö –∫—É—Ä—Å–æ–≤:</b>\n"
            "‚Ä¢ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –º–æ–¥—É–ª–∏ –∏ –ø–æ—à–∞–≥–æ–≤—ã–µ –≤–∏–¥–µ–æ—É—Ä–æ–∫–∏\n"
            "‚Ä¢ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è —Å –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑—å—é –æ—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è\n"
            "‚Ä¢ –î–æ—Å—Ç—É–ø –∫ –∑–∞–∫—Ä—ã—Ç–æ–º—É —á–∞—Ç—É –¥–ª—è –æ–±—â–µ–Ω–∏—è –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏\n"
            "‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π\n\n"
            "<a href='https://leko-moda.com/'>üëâ –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç ‚ù§Ô∏è Lekomoda</a>",
            reply_markup=keyboard
        )
    else:
        await send_access_message(message)

@dp.message(F.text.in_({"–ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å", "/progress"}))
async def progress_handler(message: types.Message):
    count = await get_progress(message.from_user.id)
    if count < 5:
        await message.answer(f"üìä –í—ã –ø—Ä–∏–≥–ª–∞—Å–∏–ª–∏ <b>{count}</b> –∏–∑ 5 –¥—Ä—É–∑–µ–π. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ!", reply_markup=keyboard)
    else:
        await send_access_message(message)

async def send_access_message(message: types.Message):
    await message.answer(
        "üéâ <b>–û—Ç–ª–∏—á–Ω–æ! –í—ã –ø—Ä–∏–≥–ª–∞—Å–∏–ª–∏ 5 –¥—Ä—É–∑–µ–π.</b>\n"
        "–¢–µ–ø–µ—Ä—å –≤–∞–º –æ—Ç–∫—Ä—ã—Ç –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —É—Ä–æ–∫–∞–º –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º!\n\n"
        "<b>üìö –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —É—Ä–æ–∫–æ–≤:</b>\n"
        "‚Ä¢ –í–≤–µ–¥–µ–Ω–∏–µ –≤ —Ü–∏—Ñ—Ä–æ–≤–æ–µ –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–¥–µ–∂–¥—ã\n"
        "‚Ä¢ –ü—Ä–æ—Å—Ç—ã–µ –ø—Ä–æ–µ–∫—Ç—ã –¥–ª—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏\n"
        "‚Ä¢ –°–æ–≤–µ—Ç—ã –ø–æ –≤—ã–±–æ—Ä—É –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è\n\n"
        "<b>üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–ª–∞—Ç–Ω—ã—Ö –∫—É—Ä—Å–æ–≤:</b>\n"
        "‚Ä¢ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –º–æ–¥—É–ª–∏ –∏ –ø–æ—à–∞–≥–æ–≤—ã–µ –≤–∏–¥–µ–æ—É—Ä–æ–∫–∏\n"
        "‚Ä¢ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è —Å –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑—å—é –æ—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è\n"
        "‚Ä¢ –î–æ—Å—Ç—É–ø –∫ –∑–∞–∫—Ä—ã—Ç–æ–º—É —á–∞—Ç—É –¥–ª—è –æ–±—â–µ–Ω–∏—è –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏\n"
        "‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π\n\n"
        "<a href='https://leko-moda.com/'>üëâ –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç ‚ù§Ô∏è Lekomoda</a>"
    )

async def main():
    await init_db()
    # –ù–µ –Ω—É–∂–Ω–æ include_router(dp)
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
